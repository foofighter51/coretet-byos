# CoreTet Development Context - August 3, 2025

## Current Status
The Arrangements feature has been successfully implemented with section creation working. The main components are complete, but audio playback for individual sections is not yet functional.

## Recent Work Completed

### 1. Arrangements UI Implementation
- ✅ Created BPM-based grid system for precise section marking
- ✅ Implemented click-to-create section interface with visual feedback
- ✅ Built section management UI (list, edit names, change colors, delete)
- ✅ Grid lines properly positioned underneath waveform as requested
- ✅ Snap-to-grid functionality at beat, bar, or 4-bar phrase levels

### 2. Database Schema Issues Fixed
- **Problem**: `audio_sections` table used `color` field but code expected `color_index`
- **Solution**: Updated all components to use color strings (#3B82F6, etc.) instead of indices
- **Files Updated**:
  - `/src/types/index.ts` - Changed AudioSection interface
  - `/src/components/Arrangements/ArrangementEditor.tsx`
  - `/src/components/Arrangements/SectionMarker.tsx`
  - `/src/components/Arrangements/SectionList.tsx`

### 3. Authentication/RLS Policy Issues Resolved
- **Problem**: RLS policy violations when creating sections on localhost
- **Root Cause**: Supabase auth token not being passed properly in localhost development
- **Solution**: Created database function with SECURITY DEFINER to handle auth context
- **Migration**: `/supabase/migrations/20250802_fix_audio_sections_auth.sql`
- **Key Learning**: When SQL query `SELECT auth.uid()` returns null, it means JWT token isn't reaching database

### 4. Other Fixes
- ✅ Fixed duplicate key warning in ToastProvider (using timestamp-based IDs)
- ✅ Fixed VersionHistory TypeError (null check for uploadedAt)
- ✅ Fixed grid visibility issues (proper duration handling)

## Current Architecture

### Arrangements Components
```
/src/components/Arrangements/
├── ArrangementEditor.tsx    # Main container, handles section CRUD
├── ArrangementWaveform.tsx  # Waveform with BPM grid overlay
├── SectionMarker.tsx        # Visual section representation
├── SectionList.tsx          # Section management interface
└── README.md               # Feature documentation
```

### Database Tables
- `audio_sections` - Stores section markers (name, start/end times, color)
- `arrangements` - Different arrangements of a track (future)
- `arrangement_sections` - Links sections to arrangements (future)

### Key Integration Points
- Arrangements UI is accessed via "Edit Arrangements" button in TrackDetailsPanel
- Requires track to have BPM/tempo set
- Uses DetailedWaveform component with added grid overlay
- Sections are stored per track with RLS policies

## What's Not Working Yet

### 1. Section Playback
- The `playSection` function in ArrangementEditor is stubbed out
- Need to enhance AudioContext to support:
  - Playing from specific start time
  - Stopping at specific end time
  - Looping a section

### 2. Arrangement Builder
- Drag & drop interface to reorder sections
- Save multiple arrangements per track
- Export arrangements as new audio files

## Next Steps

### Immediate Priority: Section Playback
To implement section playback, you'll need to:

1. **Enhance AudioContext** (`/src/contexts/AudioContext.tsx`):
   ```typescript
   // Add methods like:
   playSection(trackId: string, url: string, startTime: number, endTime: number, loop?: boolean)
   stopSection()
   ```

2. **Update ArrangementEditor** to use new audio methods:
   ```typescript
   const playSection = (section: AudioSection) => {
     audioContext.playSection(track.id, track.url, section.start_time, section.end_time, true);
   };
   ```

3. **Consider using Web Audio API** directly for precise timing:
   - AudioBufferSourceNode for sample-accurate playback
   - Loop points for section looping
   - Scheduled stop time

### Future Enhancements
1. **Snap-to-grid improvements**:
   - Visual grid snapping indicators
   - Adjustable grid resolution
   - Tempo detection from audio

2. **Section templates**:
   - Quick templates (Intro, Verse, Chorus, etc.)
   - Copy/paste sections
   - Batch operations

3. **Arrangement builder**:
   - Drag & drop timeline
   - Multiple arrangement versions
   - Export to new file

## Important Notes

### Authentication on Localhost
- The RLS policy issue is specific to localhost development
- The `create_audio_section` RPC function works around this
- In production, direct inserts should work fine
- Always check `SELECT auth.uid()` in SQL editor to verify auth

### Testing the Feature
1. Select a track with BPM set
2. Click "Edit Arrangements"
3. Click on waveform to mark start, click again for end
4. Sections appear in the list below
5. Can change colors, edit names, delete sections

### Current User Flow
1. User must be logged in
2. Track must belong to the user
3. Track must have BPM/tempo set
4. Grid can be toggled on/off
5. Sections snap to grid based on settings

## Environment Details
- Localhost development: http://localhost:5173
- Supabase project: chynnmeidbcqsnswlxmt
- Current user for testing: ericexley@gmail.com

## Files to Review
- `/src/components/Arrangements/ArrangementEditor.tsx` - Main logic
- `/src/contexts/AudioContext.tsx` - Where playback enhancements are needed
- `/supabase/migrations/20250802_fix_audio_sections_auth.sql` - Auth workaround
- `/src/components/Audio/DetailedWaveform.tsx` - Base waveform component

## Known Issues
- Grid might not appear until audio duration is loaded
- Section creation requires clicking precisely on waveform (not on controls)
- Color cycling through 6 predefined colors (Blue, Red, Green, Yellow, Purple, Pink)